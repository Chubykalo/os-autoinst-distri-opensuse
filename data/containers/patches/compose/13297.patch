From e65b3eba2a23b117b44d9c4a32e1cbd0974cc814 Mon Sep 17 00:00:00 2001
From: Ricardo Branco <rbranco@suse.de>
Date: Sat, 18 Oct 2025 22:35:54 +0200
Subject: [PATCH] test: Make tests runnable on SELinux enabled daemon

Signed-off-by: Ricardo Branco <rbranco@suse.de>
---
 pkg/e2e/compose_run_test.go                            |  2 +-
 pkg/e2e/fixtures/bridge/compose.yaml                   |  4 ++++
 pkg/e2e/fixtures/configs/compose.yaml                  |  8 ++++++++
 pkg/e2e/fixtures/hooks/compose.yaml                    |  4 ++--
 pkg/e2e/fixtures/logs-test/cat.yaml                    |  2 +-
 .../project-volume-bind-test/docker-compose.yml        |  2 ++
 pkg/e2e/fixtures/recreate-volumes/compose.yaml         |  2 +-
 pkg/e2e/fixtures/run-test/compose.yaml                 |  2 ++
 pkg/e2e/fixtures/stdout-stderr/compose.yaml            |  2 +-
 pkg/e2e/fixtures/switch-volumes/compose.yaml           |  2 +-
 pkg/e2e/fixtures/volume-test/compose.yaml              | 10 ++++++----
 pkg/e2e/fixtures/volumes/compose.yaml                  |  4 +++-
 pkg/e2e/fixtures/watch/compose.yaml                    |  4 ++--
 13 files changed, 34 insertions(+), 14 deletions(-)

diff --git a/pkg/e2e/compose_run_test.go b/pkg/e2e/compose_run_test.go
index 36a1fd49c2f..20798c42c0a 100644
--- a/pkg/e2e/compose_run_test.go
+++ b/pkg/e2e/compose_run_test.go
@@ -87,7 +87,7 @@ func TestLocalComposeRun(t *testing.T) {
 	t.Run("compose run --volumes", func(t *testing.T) {
 		wd, err := os.Getwd()
 		assert.NilError(t, err)
-		res := c.RunDockerComposeCmd(t, "-f", "./fixtures/run-test/compose.yaml", "run", "--volumes", wd+":/foo",
+		res := c.RunDockerComposeCmd(t, "-f", "./fixtures/run-test/compose.yaml", "run", "--volumes", wd+":/foo:z",
 			"back", "/bin/sh", "-c", "ls /foo")
 		res.Assert(t, icmd.Expected{Out: "compose_run_test.go"})
 
diff --git a/pkg/e2e/fixtures/bridge/compose.yaml b/pkg/e2e/fixtures/bridge/compose.yaml
index 4fbd9bd94cf..e8002ac9ea6 100644
--- a/pkg/e2e/fixtures/bridge/compose.yaml
+++ b/pkg/e2e/fixtures/bridge/compose.yaml
@@ -9,6 +9,8 @@ services:
     configs:
       - source: my-config
         target: /etc/my-config1.txt
+    security_opt:
+      - label=disable
   serviceB:
     image: alpine
     build: .
@@ -19,6 +21,8 @@ services:
     networks:
       - private-network
       - public-network
+    security_opt:
+      - label=disable
 configs:
   my-config:
     file: my-config.txt
diff --git a/pkg/e2e/fixtures/configs/compose.yaml b/pkg/e2e/fixtures/configs/compose.yaml
index 34d4827dda5..a227dbdef7a 100644
--- a/pkg/e2e/fixtures/configs/compose.yaml
+++ b/pkg/e2e/fixtures/configs/compose.yaml
@@ -4,18 +4,24 @@ services:
     configs:
       - source: from_env
     command: cat /from_env
+    security_opt:
+      - label=disable
 
   from_file:
     image: alpine
     configs:
       - source: from_file
     command: cat /from_file
+    security_opt:
+      - label=disable
 
   inlined:
     image: alpine
     configs:
       - source: inlined
     command: cat /inlined
+    security_opt:
+      - label=disable
 
   target:
     image: alpine
@@ -23,6 +29,8 @@ services:
       - source: inlined
         target: /target
     command: cat /target
+    security_opt:
+      - label=disable
 
 configs:
   from_env:
diff --git a/pkg/e2e/fixtures/hooks/compose.yaml b/pkg/e2e/fixtures/hooks/compose.yaml
index b45a65df063..31d2b4a80ad 100644
--- a/pkg/e2e/fixtures/hooks/compose.yaml
+++ b/pkg/e2e/fixtures/hooks/compose.yaml
@@ -2,7 +2,7 @@ services:
   sample:
     image: nginx
     volumes:
-      - data:/data
+      - "data:/data:z"
     pre_stop:
       - command: sh -c 'echo "In the pre-stop" >> /data/log.txt'
   test:
@@ -11,4 +11,4 @@ services:
       - command: sh -c 'echo env'
 volumes:
   data:
-    name: sample-data
\ No newline at end of file
+    name: sample-data
diff --git a/pkg/e2e/fixtures/logs-test/cat.yaml b/pkg/e2e/fixtures/logs-test/cat.yaml
index 76bd5a9ab64..3327d1894ec 100644
--- a/pkg/e2e/fixtures/logs-test/cat.yaml
+++ b/pkg/e2e/fixtures/logs-test/cat.yaml
@@ -3,4 +3,4 @@ services:
     image: alpine
     command: cat /text_file.txt
     volumes:
-      - ${FILE}:/text_file.txt
+      - "${FILE}:/text_file.txt:z"
diff --git a/pkg/e2e/fixtures/project-volume-bind-test/docker-compose.yml b/pkg/e2e/fixtures/project-volume-bind-test/docker-compose.yml
index 7e1795719df..d06ff466633 100644
--- a/pkg/e2e/fixtures/project-volume-bind-test/docker-compose.yml
+++ b/pkg/e2e/fixtures/project-volume-bind-test/docker-compose.yml
@@ -4,6 +4,8 @@ services:
     container_name: frontend
     volumes:
       - project-data:/data
+    security_opt:
+      - label=disable
 
 volumes:
   project-data:
diff --git a/pkg/e2e/fixtures/recreate-volumes/compose.yaml b/pkg/e2e/fixtures/recreate-volumes/compose.yaml
index e0e40c721b7..bc6d4e038cb 100644
--- a/pkg/e2e/fixtures/recreate-volumes/compose.yaml
+++ b/pkg/e2e/fixtures/recreate-volumes/compose.yaml
@@ -2,7 +2,7 @@ services:
   app:
     image: alpine
     volumes:
-      - my_vol:/my_vol
+      - "my_vol:/my_vol:z"
 
 volumes:
   my_vol:
diff --git a/pkg/e2e/fixtures/run-test/compose.yaml b/pkg/e2e/fixtures/run-test/compose.yaml
index aef80119039..514a1703804 100644
--- a/pkg/e2e/fixtures/run-test/compose.yaml
+++ b/pkg/e2e/fixtures/run-test/compose.yaml
@@ -12,6 +12,8 @@ services:
       - backnet
     volumes:
       - data:/test
+    security_opt:
+      - label=disable
   front:
     image: nginx:alpine
     networks:
diff --git a/pkg/e2e/fixtures/stdout-stderr/compose.yaml b/pkg/e2e/fixtures/stdout-stderr/compose.yaml
index 53a44b4552c..48885b63c56 100644
--- a/pkg/e2e/fixtures/stdout-stderr/compose.yaml
+++ b/pkg/e2e/fixtures/stdout-stderr/compose.yaml
@@ -4,4 +4,4 @@ services:
     init: true
     command: /bin/ash /log_to_stderr.sh
     volumes:
-           - ./log_to_stderr.sh:/log_to_stderr.sh
+           - "./log_to_stderr.sh:/log_to_stderr.sh:z"
diff --git a/pkg/e2e/fixtures/switch-volumes/compose.yaml b/pkg/e2e/fixtures/switch-volumes/compose.yaml
index 9da0dcba175..7af5caca67b 100644
--- a/pkg/e2e/fixtures/switch-volumes/compose.yaml
+++ b/pkg/e2e/fixtures/switch-volumes/compose.yaml
@@ -2,7 +2,7 @@ services:
   app:
     image: alpine
     volumes:
-      - my_vol:/my_vol
+      - "my_vol:/my_vol:z"
 
 volumes:
   my_vol:
diff --git a/pkg/e2e/fixtures/volume-test/compose.yaml b/pkg/e2e/fixtures/volume-test/compose.yaml
index 7567da42ef8..25d1bda91cf 100644
--- a/pkg/e2e/fixtures/volume-test/compose.yaml
+++ b/pkg/e2e/fixtures/volume-test/compose.yaml
@@ -2,22 +2,24 @@ services:
   nginx:
     build: nginx-build
     volumes:
-      - ./static:/usr/share/nginx/html
+      - "./static:/usr/share/nginx/html:z"
     ports:
       - 8090:80
 
   nginx2:
     build: nginx-build
     volumes:
-      - staticVol:/usr/share/nginx/html:ro
+      - "staticVol:/usr/share/nginx/html:ro,z"
       - /usr/src/app/node_modules
-      - otherVol:/usr/share/nginx/test
+      - "otherVol:/usr/share/nginx/test:z"
     ports:
       - 9090:80
     configs:
       - myconfig
     secrets:
       - mysecret
+    security_opt:
+      - label=disable
 
 volumes:
   staticVol:
@@ -30,4 +32,4 @@ configs:
 
 secrets:
   mysecret:
-    file: ./static/index.html
\ No newline at end of file
+    file: ./static/index.html
diff --git a/pkg/e2e/fixtures/volumes/compose.yaml b/pkg/e2e/fixtures/volumes/compose.yaml
index 4aad0482b5d..ee7255d2dd5 100644
--- a/pkg/e2e/fixtures/volumes/compose.yaml
+++ b/pkg/e2e/fixtures/volumes/compose.yaml
@@ -7,4 +7,6 @@ services:
         source: nginx:alpine
         target: /mnt/image
         image:
-          subpath: usr/share/nginx/html/
\ No newline at end of file
+          subpath: usr/share/nginx/html/
+    security_opt:
+      - label=disable
diff --git a/pkg/e2e/fixtures/watch/compose.yaml b/pkg/e2e/fixtures/watch/compose.yaml
index 7e5e0d28bf4..ec0c2a8a21b 100644
--- a/pkg/e2e/fixtures/watch/compose.yaml
+++ b/pkg/e2e/fixtures/watch/compose.yaml
@@ -38,6 +38,6 @@ services:
     init: true
     command: sleep infinity
     volumes:
-      - ./dat:/app/dat
-      - ./data-logs:/app/data-logs
+      - "./dat:/app/dat:z"
+      - "./data-logs:/app/data-logs:z"
     develop: *x-dev
